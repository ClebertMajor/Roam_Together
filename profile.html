<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roam Together â€“ Profile</title>
  <link rel="stylesheet" href="css/profile.css" />
</head>

<body>

  <!-- ===== HEADER BAR ===== -->
  <header>
    <div class="logo-wrap">
      <img src="css/images/logo.png" class="logo" alt="Roam Together Logo">
    </div>

    <div class="nav-buttons">
      <a href="home.html">Home</a>
      <a href="explore.html">Explore</a>
    </div>
  </header>

  <!-- ===== PROFILE BOX ===== -->
  <div class="profile-container">
    <h1>My Profile</h1>

    <img id="preview" class="profile-pic" src="" alt="Profile Picture" />

    <input type="file" id="upload" accept="image/*" />

    <div class="user-info">
      <div><strong>Name:</strong> <span id="user-name">Loading...</span></div>
      <div><strong>Travel Style:</strong> <span id="user-style">Loading...</span></div>
    </div>

    <label for="bio"><strong>Bio:</strong></label>
    <textarea id="bio" placeholder="Write something about yourself..."></textarea>

    <button id="saveBtn">Save Profile</button>
  </div>

   <!-- ========================= -->
  <!--     FIREBASE MODULE       -->
  <!-- ========================= -->
  <script type="module">
  /* IMPORT FIREBASE CORE */
  import { app, auth, db, storage } from "./js/firebaseConfig.js";

  /* FIREBASE AUTH + FIRESTORE METHODS */
  import {
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  import {
    doc,
    getDoc,
    setDoc
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  /* FIREBASE STORAGE METHODS */
  import {
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";


  /* --------------------------- */
  /*   PROFILE PAGE ELEMENTS     */
  /* --------------------------- */
  const upload = document.getElementById("upload");
  const preview = document.getElementById("preview");
  const userNameSpan = document.getElementById("user-name");
  const userStyleSpan = document.getElementById("user-style");
  const bioTextarea = document.getElementById("bio");
  const saveBtn = document.getElementById("saveBtn");

  let currentUserId = null;
  let selectedImageFile = null;


  /* --------------------------- */
  /*   IMAGE PREVIEW LOGIC       */
  /* --------------------------- */
  upload.addEventListener("change", function () {
    selectedImageFile = this.files[0];  // store the image for saving

    if (selectedImageFile) {
      preview.src = URL.createObjectURL(selectedImageFile);
    }
  });


  /* --------------------------- */
  /*   ON USER LOGIN             */
  /* --------------------------- */
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // If not logged in, send back to login
      window.location.href = "home.html";
      return;
    }

    currentUserId = user.uid;

    // Load Firestore profile data
    const docRef = doc(db, "users", currentUserId);
    const snap = await getDoc(docRef);

    if (snap.exists()) {
      const data = snap.data();

      userNameSpan.textContent = data.name || "Not set";
      userStyleSpan.textContent = data.travelStyle || "Not set";
      bioTextarea.value = data.bio || "";

      if (data.profilePicURL) {
        preview.src = data.profilePicURL;
      }

    } else {
      // No Firestore doc yet
      userNameSpan.textContent = user.email;
      userStyleSpan.textContent = "Not set";
      bioTextarea.value = "";
    }
  });


  /* --------------------------- */
  /*   SAVE PROFILE (BIO + PIC)  */
  /* --------------------------- */
  saveBtn.addEventListener("click", async () => {
    if (!currentUserId) {
      alert("You must be logged in to save your profile.");
      return;
    }

    const newBio = bioTextarea.value.trim();
    const userDocRef = doc(db, "users", currentUserId);

    let profilePicURL = null;

    /* ---- ONLY UPLOAD IF IMAGE SELECTED ---- */
    if (selectedImageFile) {
      const imageRef = ref(storage, `profilePictures/${currentUserId}/profile.jpg`);

      // Upload image to Firebase Storage
      await uploadBytes(imageRef, selectedImageFile);

      // Get permanent download URL
      profilePicURL = await getDownloadURL(imageRef);
    }

    /* ---- SAVE BIO + PROFILE PIC URL TO FIRESTORE ---- */
    await setDoc(
      userDocRef,
      {
        bio: newBio,
        ...(profilePicURL ? { profilePicURL: profilePicURL } : {})
      },
      { merge: true }
    );

    alert("Profile saved!");
  });
</script>

</body>
</html>
